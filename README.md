# üîê Keycloak MFA Setup ‚Äî TOTP & Email OTP

A complete Multi-Factor Authentication (MFA) implementation using **Keycloak 26.1.0** on Ubuntu 22.04, featuring both **TOTP (Authenticator App)** and **Email OTP** with a Node.js demo application.

> Everything runs on **localhost** ‚Äî no Docker, Kubernetes, domain, or SSL required.

---

## ‚ú® Features

- **Keycloak 26.1.0** (Quarkus distribution) with OpenJDK 21
- **TOTP Authentication** via Google Authenticator / Authy / FreeOTP
- **Email OTP Authentication** using [5-stones/keycloak-email-otp](https://github.com/5-stones/keycloak-email-otp) SPI plugin
- **Custom Authentication Flow** ‚Äî configurable MFA with both TOTP and Email OTP
- **Node.js Demo App** ‚Äî OIDC login with PKCE, styled landing page
- **SMTP Integration** ‚Äî tested with Mailtrap sandbox

---

## üìÅ Project Structure

```
Keycloak_Setup/
‚îú‚îÄ‚îÄ README.md                    # This file
‚îú‚îÄ‚îÄ SETUP_GUIDE.md               # Detailed step-by-step setup documentation
‚îú‚îÄ‚îÄ demo-app/
‚îÇ   ‚îú‚îÄ‚îÄ package.json             # Node.js dependencies
‚îÇ   ‚îî‚îÄ‚îÄ index.js                 # OIDC demo app (Express + openid-client)
‚îî‚îÄ‚îÄ docs/
    ‚îî‚îÄ‚îÄ architecture.md          # (Optional) Architecture notes
```

### External Dependencies (not in this repo)

| Component | Location | Source |
|---|---|---|
| Keycloak 26.1.0 | `/opt/keycloak/` | [keycloak/keycloak](https://github.com/keycloak/keycloak/releases) |
| Email OTP Plugin | `/opt/keycloak/providers/` | [5-stones/keycloak-email-otp](https://github.com/5-stones/keycloak-email-otp) |

---

## üèóÔ∏è Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Browser        ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ   Node.js Demo App   ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ   Keycloak   ‚îÇ
‚îÇ   (localhost:3000)‚îÇ        ‚îÇ   (Express + OIDC)   ‚îÇ       ‚îÇ  (port 8082) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                                  ‚îÇ
                                                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                                          ‚îÇ  SMTP Server ‚îÇ
                                                          ‚îÇ  (Mailtrap)  ‚îÇ
                                                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Authentication Flow

```
User visits localhost:3000
        ‚îÇ
        ‚ñº
  Click "Login with Keycloak"
        ‚îÇ
        ‚ñº
  Redirect to Keycloak (port 8082)
        ‚îÇ
        ‚ñº
  Enter Username + Password
        ‚îÇ
        ‚ñº
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ  MFA Verification       ‚îÇ
  ‚îÇ  ‚Ä¢ TOTP (Authenticator) ‚îÇ
  ‚îÇ  ‚Ä¢ Email OTP            ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ
        ‚ñº
  Redirect back to localhost:3000
        ‚îÇ
        ‚ñº
  "Welcome, testuser!" üéâ
```

---

## üöÄ Quick Start

> See [SETUP_GUIDE.md](SETUP_GUIDE.md) for detailed instructions.

### Prerequisites

- Ubuntu 22.04 LTS
- OpenJDK 21
- Maven
- Node.js (v14+)

### 1. Start Keycloak

```bash
export KEYCLOAK_ADMIN=admin
export KEYCLOAK_ADMIN_PASSWORD=<your-password>
/opt/keycloak/bin/kc.sh start-dev --http-port=8082
```

### 2. Run Demo App

```bash
cd demo-app
npm install
node index.js
# Open http://localhost:3000
```

### 3. Login

- Open `http://localhost:3000` ‚Üí Click **Login with Keycloak**
- Username: `testuser` / Password: `test123`
- Complete MFA verification (TOTP or Email OTP)
- See the Welcome page!

---

## üîß Technology Stack

| Technology | Version | Purpose |
|---|---|---|
| Keycloak | 26.1.0 | Identity & Access Management |
| OpenJDK | 21 | Keycloak runtime |
| Node.js | 14+ | Demo application |
| Express | 4.x | Web server |
| openid-client | 5.x | OIDC client library |
| Maven | 3.x | Building Keycloak plugins |

---

## üîë Key Concepts

| Concept | Description |
|---|---|
| **Realm** | Isolated namespace for users, clients, and auth config (`local_demo`) |
| **Client** | Application registered with Keycloak (`demo-app`) |
| **TOTP** | Time-based One-Time Password ‚Äî generated by authenticator app |
| **Email OTP** | One-time code sent via SMTP to user's email |
| **SPI** | Service Provider Interface ‚Äî Keycloak's extension mechanism |
| **OIDC** | OpenID Connect ‚Äî authentication protocol used by demo app |
| **PKCE** | Proof Key for Code Exchange ‚Äî security extension for public clients |

---

## üõ°Ô∏è Security Notes

- This setup runs in **development mode** ‚Äî do NOT use in production without:
  - Enabling HTTPS
  - Using a production database (PostgreSQL)
  - Setting strong admin passwords
  - Configuring proper CORS and CSP headers
- SMTP credentials should be stored as environment variables, not in code
- The demo app session secret should be changed for any real deployment

---

## üìö References

- [Keycloak Documentation](https://www.keycloak.org/documentation)
- [5-stones Email OTP Plugin](https://github.com/5-stones/keycloak-email-otp)
- [OpenID Connect Specification](https://openid.net/connect/)
- [openid-client npm](https://www.npmjs.com/package/openid-client)

---

## üìÑ License

This project is for educational and demonstration purposes.
